<story-context id="2-6-segmentation-prompt-trojan-horse" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>6</storyId>
    <title>Session Plan Selection</title>
    <status>drafted</status>
    <generatedAt>2025-12-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-6-segmentation-prompt-trojan-horse.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to choose the right plan for my current project</iWant>
    <soThat>I get the appropriate level of depth and safety for my specific needs</soThat>
    <tasks>
      - [ ] **Task 1: Update Database Schema** (AC: 2.6.4)
      - [ ] 1.1 Verify `naming_sessions` table in `server/lib/db/schema/public.ts` has `plan` enum
      column ('velocity', 'legacy')
      - [ ] 1.2 If missing, create migration to add `plan` column
      - [ ] 1.3 Remove `segment` from `user_profiles` table if present (cleanup from previous
      design)

      - [ ] **Task 2: Update Session Store** (AC: 2.6.7, 2.6.8)
      - [ ] 2.1 Update `SessionState` in `components/lib/stores/session-store.ts` to include
      `currentSessionPlan`
      - [ ] 2.2 Add action `setSessionPlan(plan: 'velocity' | 'legacy')`
      - [ ] 2.3 Ensure `reset()` clears the plan selection
      - [ ] 2.4 Add unit tests for store updates in `tests/unit/stores/session-store.test.ts`

      - [ ] **Task 3: Create Plan Selection Component** (AC: 2.6.2, 2.6.3)
      - [ ] 3.1 Create `components/features/onboarding/plan-selection.tsx`
      - [ ] 3.2 Implement UI for "Velocity" vs "Legacy" cards using shadcn/ui Card
      - [ ] 3.3 Add visual distinction (Electric Teal vs Indigo/Gold)
      - [ ] 3.4 Implement selection handler that calls `setSessionPlan` and server action
      - [ ] 3.5 Add component tests in
      `tests/unit/components/features/onboarding/plan-selection.test.tsx`

      - [ ] **Task 4: Implement Server Action for Session** (AC: 2.6.4)
      - [ ] 4.1 Create/Update `createNamingSession` in `server/actions/naming.ts`
      - [ ] 4.2 Validate input using Zod (industry, description, plan)
      - [ ] 4.3 Insert into `naming_sessions` table
      - [ ] 4.4 Return session ID

      - [ ] **Task 5: Integrate with Chat Interface** (AC: 2.6.1, 2.6.5, 2.6.6)
      - [ ] 5.1 Update `components/features/naming/chat-interface.tsx` to check `currentSessionPlan`
      - [ ] 5.2 If no plan selected, render `PlanSelection` component (or overlay)
      - [ ] 5.3 Pass selected plan to `NarrativeArchitect` system prompt generation
      - [ ] 5.4 Ensure `useChat` hook receives the correct initial system prompt

      - [ ] **Task 6: E2E Testing** (AC: 2.6.1 - 2.6.8)
      - [ ] 6.1 Create `tests/e2e/naming-flow.spec.ts`
      - [ ] 6.2 Test flow: Start -> Input Details -> Select Plan -> Verify Chat Interface loads
      - [ ] 6.3 Verify session is persisted in DB (via API or UI check)
    </tasks>
  </story>

  <acceptanceCriteria>
    | AC ID | Criteria | Source |
    | -------- |
    --------------------------------------------------------------------------------------------------------------------
    | ------------------------------------ |
    | AC-2.6.1 | User is presented with Plan Selection screen after providing initial business
    details (Industry, Description) | [Epics: Story 2.6] |
    | AC-2.6.2 | **Plan A ("Velocity Plan")** is displayed with: Tagline "Name it. Claim it. Launch
    it.", Focus on Speed/Availability | [Epics: Story 2.6] |
    | AC-2.6.3 | **Plan B ("Legacy Plan")** is displayed with: Tagline "Build a Brand That Lasts.",
    Focus on Defensibility/Safety | [Epics: Story 2.6] |
    | AC-2.6.4 | Selecting a plan creates a session with `plan: 'velocity' | 'legacy'` | [Epics:
    Story 2.6] |
    | AC-2.6.5 | User is taken to Narrative Architect chat interface after selection | [Epics: Story
    2.6] |
    | AC-2.6.6 | AI system prompt is initialized with the selected plan's persona | [Epics: Story
    2.6] |
    | AC-2.6.7 | Plan selection applies **only to the current session** | [Epics: Story 2.6] |
    | AC-2.6.8 | User can start a new session later with a different plan | [Epics: Story 2.6] |
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Pattern 1: The "Trojan Horse" Session Plan</title>
        <section>Pattern 1: The "Trojan Horse" Session Plan</section>
        <snippet>
          - **Purpose:** Bifurcate users into "Velocity" (Speed) vs "Legacy" (Safety) paths for
          *each* naming session.
          - **Components:** `PlanSelection` (Client), `session-store.ts` (Zustand).
          - **Data Flow:**
          1. User starts new session (or first run)
          2. Check `session-store.currentSessionPlan` → if null, render `PlanSelection` overlay
          3. User selects plan → Update `currentSessionPlan` in store + persist to
          `naming_sessions.plan`
        </snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design - Novel UX Patterns</title>
        <section>2.2 Novel UX Patterns</section>
        <snippet>
          **1. The "Trojan Horse" Criteria Collection:**
          - **Concept:** The initial chat/form isn't just for ideation; it's a segmentation tool.
          - **Mechanism:** A "Segmentation Prompt" at the very start forces a choice:
          - **Path A (Speed):** "I need a name fast." (Lean Entrepreneur)
          - **Path B (Certainty):** "I need a defensible brand." (High-Stakes Founder)
        </snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics - Story 2.6</title>
        <section>Story 2.6: Session Plan Selection</section>
        <snippet>
          **Plan A - "Velocity Plan" (Free)**
          - Tagline: "Name it. Claim it. Launch it."
          - Visual: Electric Teal, Speed imagery

          **Plan B - "Legacy Plan" (Premium)**
          - Tagline: "Build a Brand That Lasts."
          - Visual: Indigo/Gold, Shield/Fortress imagery
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>server/lib/db/schema/public.ts</path>
        <kind>schema</kind>
        <symbol>namingSessions</symbol>
        <lines>66-78</lines>
        <reason>Table where 'plan' column needs to be added and 'criteria' is stored.</reason>
      </item>
      <item>
        <path>server/lib/db/schema/public.ts</path>
        <kind>schema</kind>
        <symbol>userProfiles</symbol>
        <lines>29-48</lines>
        <reason>Table where 'segment' column needs to be removed.</reason>
      </item>
      <item>
        <path>components/lib/stores/session-store.ts</path>
        <kind>store</kind>
        <symbol>SessionState</symbol>
        <lines>8-11</lines>
        <reason>State interface needs update to replace userType with currentSessionPlan.</reason>
      </item>
    </code>
    <dependencies>
      <dep>zustand: ^5.0.9</dep>
      <dep>drizzle-orm: ^0.44.7</dep>
      <dep>zod: ^4.1.13</dep>
      <dep>@ai-sdk/google: ^2.0.43</dep>
      <dep>ai: ^5.0.102</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Architecture</type>
      <description>Must implement "Trojan Horse" pattern: [New Session] -> [PlanSelection] -> [Plan
        Selected] -> [Chat Interface]</description>
    </constraint>
    <constraint>
      <type>Database</type>
      <description>Use Drizzle ORM for all DB changes. `naming_sessions` table must have `plan` enum
        column.</description>
    </constraint>
    <constraint>
      <type>State Management</type>
      <description>Use Zustand `session-store` to track `currentSessionPlan`. Do not use React
        Context for high-frequency updates.</description>
    </constraint>
    <constraint>
      <type>UI/UX</type>
      <description>Plan Selection must be visually distinct (Teal vs Indigo/Gold) as per UX spec.</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>createNamingSession</name>
      <kind>Server Action</kind>
      <signature>createNamingSession(input: { industry: string, description: string, plan:
        'velocity' | 'legacy' }): Promise&lt;ActionResponse&lt;{ sessionId: string }&gt;&gt;</signature>
      <path>server/actions/naming.ts</path>
    </interface>
    <interface>
      <name>setSessionPlan</name>
      <kind>Store Action</kind>
      <signature>setSessionPlan(plan: 'velocity' | 'legacy'): void</signature>
      <path>components/lib/stores/session-store.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <unit>Vitest for services (80% coverage) and stores.</unit>
      <component>Vitest + React Testing Library for interactive components (PlanSelection).</component>
      <e2e>Playwright for critical user flows (Start -> Select Plan -> Chat).</e2e>
    </standards>
    <locations>
      <loc>tests/unit/stores/session-store.test.ts</loc>
      <loc>tests/unit/components/features/onboarding/plan-selection.test.tsx</loc>
      <loc>tests/e2e/naming-flow.spec.ts</loc>
    </locations>
    <ideas>
      <idea>Unit: Verify `setSessionPlan` updates store state correctly.</idea>
      <idea>Unit: Verify `reset` clears the plan selection.</idea>
      <idea>Component: Verify `PlanSelection` renders both cards with correct visual styles.</idea>
      <idea>Component: Verify clicking a plan triggers the selection handler.</idea>
      <idea>E2E: Complete flow from Dashboard -> Plan Selection -> Chat Interface load.</idea>
      <idea>E2E: Verify session is persisted in DB with correct plan enum.</idea>
    </ideas>
  </tests>
</story-context>