<story-context id="2-8-user-profile-display-sign-out" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>8</storyId>
    <title>User Profile Display &amp; Sign Out</title>
    <status>drafted</status>
    <generatedAt>2025-12-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-8-user-profile-display-sign-out.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>logged-in user</asA>
    <iWant>see my profile information and sign out</iWant>
    <soThat>manage my session securely</soThat>
    <tasks>
      - [ ] Create `UserProfileMenu` component
      - [ ] Implement dropdown structure using `shadcn/ui` `DropdownMenu`.
      - [ ] Display user email (fetch from session).
      - [ ] Add navigation links.
      - [ ] Implement avatar with user initial fallback (AC: #5).
      - [ ] Implement Sign Out Logic
      - [ ] Create `handleSignOut` function that:
      - Navigates to `/auth/logout` (handles Supabase sign out server-side).
      - [ ] Integrate into Header
      - [ ] Add `UserProfileMenu` to `components/shared/header.tsx`.
      - [ ] Ensure proper positioning and styling.
      - [ ] Mobile Adaptation
      - [ ] Update `components/shared/mobile-header.tsx` to include profile access.
      - [ ] Testing
      - [ ] Unit test for `UserProfileMenu` rendering.
      - [ ] E2E test for sign-out flow (login -> open menu -> sign out -> verify redirect).
    </tasks>
  </story>

  <acceptanceCriteria>
    1. **Profile Dropdown:** Clicking the user avatar in the header opens a dropdown menu.
    2. **Menu Content:** The menu displays:
    - User's email address (truncated if long).
    - "Order History" link (navigates to `/orders`).
    - "Settings" link (placeholder, navigates to `/settings` or disabled).
    - Divider.
    - "Sign Out" button (destructive style).
    3. **Sign Out Flow:**
    - Clicking "Sign Out" triggers a confirmation dialog: "Are you sure you want to sign out?".
    - On confirmation:
    - Session is terminated (Supabase auth sign out).
    - Client-side state is cleared (Zustand `sessionStore` and `namingStore` reset).
    - User is redirected to `/auth/login`.
    - A toast notification appears: "You've been signed out".
    4. **Mobile Responsiveness:**
    - On mobile, the profile options are accessible via the main navigation menu or a visible
    profile icon.
    5. **Avatar:**
    - Displays the user's profile picture if available (future proofing).
    - Fallback to user's initial if no picture is available.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR1: Users can create accounts to save their progress and generated names. FR2:
          Users can log in via email or social providers.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>components/features/auth/ is the correct location for the menu component.
          server/actions/auth.ts needs to be created.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Mobile Navigation</section>
        <snippet>Top Header with View Toggle | [Profile Menu]. Rationale: Maintains consistent
          navigation placement across all breakpoints.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.8: User Profile Display &amp; Sign Out</section>
        <snippet>Detailed acceptance criteria and technical notes for this story.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>components/shared/header.tsx</path>
        <kind>component</kind>
        <symbol>Header</symbol>
        <lines>40-44</lines>
        <reason>Placeholder for User Menu needs to be replaced with UserProfileMenu.</reason>
      </item>
      <item>
        <path>components/shared/mobile-header.tsx</path>
        <kind>component</kind>
        <symbol>MobileHeader</symbol>
        <lines>46-48</lines>
        <reason>Placeholder for Profile Menu needs to be replaced/integrated.</reason>
      </item>
      <item>
        <path>components/lib/stores/session-store.ts</path>
        <kind>store</kind>
        <symbol>SessionStore</symbol>
        <lines>16</lines>
        <reason>reset() method required for sign out.</reason>
      </item>
      <item>
        <path>components/lib/stores/naming-store.ts</path>
        <kind>store</kind>
        <symbol>NamingStore</symbol>
        <lines>41</lines>
        <reason>reset() method required for sign out.</reason>
      </item>
    </code>
    <dependencies>
      <dep>@supabase/ssr</dep>
      <dep>@supabase/supabase-js</dep>
      <dep>zustand</dep>
      <dep>lucide-react</dep>
      <dep>shadcn/ui (dropdown-menu, avatar, dialog)</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Ensure `sessionStore` and `namingStore` are reset to prevent data leakage between
      users on shared devices.</constraint>
    <constraint>Use `/auth/logout` route for sign-out - Supabase auth requires server-side cookie
      clearing via route handler.</constraint>
    <constraint>Mobile adaptation must ensure profile access is intuitive alongside the view toggle.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>/auth/logout</name>
      <kind>Route</kind>
      <signature>GET /auth/logout - Handles Supabase sign out, clears session, redirects to
        /auth/login</signature>
      <path>app/auth/logout/route.ts</path>
    </interface>
    <interface>
      <name>reset</name>
      <kind>Store Action</kind>
      <signature>reset: () => void</signature>
      <path>components/lib/stores/session-store.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <unit>Vitest for unit testing components (80% coverage target).</unit>
      <component>Vitest + React Testing Library for interactive components.</component>
      <e2e>Playwright for critical user flows.</e2e>
    </standards>
    <locations>
      <loc>tests/unit/components/features/auth/user-profile-menu.test.tsx</loc>
      <loc>tests/e2e/auth.spec.ts</loc>
    </locations>
    <ideas>
      <idea>Unit test `UserProfileMenu` to ensure it renders correct links and email.</idea>
      <idea>Unit test avatar fallback to user initial when no profile picture.</idea>
      <idea>E2E test the full sign-out flow: Login -> Open Menu -> Click Sign Out -> Confirm ->
        Verify Redirect to Login -> Verify Session Cleared.</idea>
    </ideas>
  </tests>
</story-context>